<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Video en Vivo</title>
  <link rel="stylesheet" href="video-styles.css" />
  <link rel="icon" type="image/png" href="icons8-toro-48.png">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    .video-area iframe,
    .video-area video {
      width: 100%;
      height: 360px;
    }
  </style>
</head>
<body>
  <header>
    <h1 class="header-title">Transmisi√≥n en Vivo</h1>
  </header>

  <main class="main-content">
    <div class="stream-container">
      <section class="video-area-container">
        <div class="video-area" id="videoArea">
          <!-- Aqu√≠ se insertar√° el video o iframe -->
        </div>
        <button id="logoutBtn">Cerrar Sesi√≥n</button>
      </section>

      <aside class="ad-area" id="ad-area">
        <div id="timer">Tiempo restante: <span id="timeLeft">60:00</span></div>
        <h2>Promociones</h2>
        <div class="carousel">
          <img class="promo-slide active" src="gal8.jpg" alt="Promo 1" />
          <img class="promo-slide" src="gal6.jpg" alt="Promo 2" />
          <img class="promo-slide" src="gal7.jpg" alt="Promo 3" />
          <img class="promo-slide" src="gal9.jpg" alt="Promo 4" />
        </div>
      </aside>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Systems Department | Potenciando la calidad profesional</p>
  </footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAFyGzysyKuakKbvxQ4-V_dImZzRIn6sCk",
      authDomain: "proyectocamarasga.firebaseapp.com",
      databaseURL: "https://proyectocamarasga-default-rtdb.firebaseio.com",
      projectId: "proyectocamarasga",
      storageBucket: "proyectocamarasga.appspot.com",
      messagingSenderId: "234822313241",
      appId: "1:234822313241:web:3989ed7953383848d69188",
      measurementId: "G-MEGZ1G4ETH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const videoArea = document.getElementById('videoArea');
    const timeLeftSpan = document.getElementById('timeLeft');
    const tokenKey = "token_cliente";

    // üëâ CAMBIA SOLO ESTE ID si quieres otro video:
    const youtubeID = 'R9r_WSFEBR0';

    // URLs
    const cameraHLS = 'http://192.168.1.6:8888/camerahik/index.m3u8';
    const youtubeLive = `https://www.youtube.com/embed/${youtubeID}?autoplay=1&modestbranding=1&rel=0&controls=0`;

    // Funci√≥n para cargar video HLS
    function cargarVideoHLS() {
      return new Promise((resolve, reject) => {
        if (!Hls.isSupported()) {
          reject('HLS no soportado');
          return;
        }
        const video = document.createElement('video');
        video.setAttribute('controls', '');
        video.setAttribute('autoplay', '');
        video.setAttribute('muted', '');
        video.style.width = '100%';
        video.style.height = '360px';

        const hls = new Hls();
        hls.loadSource(cameraHLS);
        hls.attachMedia(video);

        video.addEventListener('loadedmetadata', () => resolve(video));
        video.addEventListener('error', () => reject('Error en reproducci√≥n de HLS'));
        setTimeout(() => reject('Timeout cargando video HLS'), 5000);
      });
    }

    // ‚úÖ Funci√≥n YouTube con capa bloqueadora
    function cargarVideoYouTube() {
      const contenedor = document.createElement('div');
      contenedor.style.position = 'relative';
      contenedor.style.width = '100%';
      contenedor.style.height = '360px';

      const preview = document.createElement('img');
      preview.src = `https://img.youtube.com/vi/${youtubeID}/hqdefault.jpg`;
      preview.alt = 'Vista previa del video';
      preview.style.width = '100%';
      preview.style.height = '100%';
      preview.style.objectFit = 'cover';

      const botonPlay = document.createElement('button');
      botonPlay.textContent = '‚ñ∂ Reproducir';
      botonPlay.style.position = 'absolute';
      botonPlay.style.top = '50%';
      botonPlay.style.left = '50%';
      botonPlay.style.transform = 'translate(-50%, -50%)';
      botonPlay.style.fontSize = '24px';
      botonPlay.style.padding = '10px 20px';
      botonPlay.style.backgroundColor = 'red';
      botonPlay.style.color = 'white';
      botonPlay.style.border = 'none';
      botonPlay.style.borderRadius = '8px';
      botonPlay.style.cursor = 'pointer';
      botonPlay.style.zIndex = '10';

      botonPlay.addEventListener('click', () => {
        contenedor.innerHTML = `
          <div style="position: relative; width: 100%; height: 360px;">
            <iframe src="${youtubeLive}"
                    frameborder="0"
                    allow="autoplay; encrypted-media"
                    allowfullscreen
                    style="width: 100%; height: 100%;"></iframe>
            <!-- Capa bloqueadora -->
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"></div>
          </div>`;
      });

      contenedor.appendChild(preview);
      contenedor.appendChild(botonPlay);
      return contenedor;
    }

    // Prioridad: intenta HLS, si falla usa YouTube
    async function cargarVideoPreferido() {
      try {
        const videoHLS = await cargarVideoHLS();
        videoArea.appendChild(videoHLS);
      } catch (error) {
        console.warn("No se pudo cargar video HLS, se usa YouTube.", error);
        const iframeYT = cargarVideoYouTube();
        videoArea.appendChild(iframeYT);
      }
    }

    // Temporizador de acceso (60 min)
    function actualizarTemporizador() {
      const expiracion = parseInt(localStorage.getItem('cliente_expiracion')) || 0;
      const ahora = Date.now();
      const diferencia = expiracion - ahora;

      if (diferencia <= 0) {
        alert("Tu acceso ha expirado. Gracias por visitarnos.");
        localStorage.clear();
        window.location.href = "index.html";
        return;
      }

      const minutos = Math.floor(diferencia / 60000);
      const segundos = Math.floor((diferencia % 60000) / 1000);
      timeLeftSpan.textContent = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
    }

    function validarSesionCliente() {
      const token = localStorage.getItem(tokenKey);
      const ahora = Date.now();
      let clienteExpiracion = parseInt(localStorage.getItem('cliente_expiracion'));

      if (!clienteExpiracion) {
        clienteExpiracion = ahora + 60 * 60 * 1000; // 60 min
        localStorage.setItem('cliente_expiracion', clienteExpiracion);
      }

      if (!token) {
        alert("Sesi√≥n no v√°lida. Inicia sesi√≥n nuevamente.");
        localStorage.clear();
        window.location.href = "index.html";
        return;
      }

      db.ref("tokens/" + token).once("value").then(snapshot => {
        const datos = snapshot.val();
        if (!datos || ahora < datos.inicio || ahora > datos.expiracion) {
          alert("Token inv√°lido o vencido.");
          localStorage.clear();
          window.location.href = "index.html";
          return;
        }

        cargarVideoPreferido();
        actualizarTemporizador();
        const intervalo = setInterval(() => {
          const expiracionLocal = parseInt(localStorage.getItem('cliente_expiracion')) || 0;
          const ahoraLocal = Date.now();
          const diff = expiracionLocal - ahoraLocal;
          if (diff <= 0) {
            clearInterval(intervalo);
            mostrarAccesoExpirado();
          } else {
            actualizarTemporizador();
          }
        }, 1000);

      }).catch(error => {
        console.error("Error al validar el token:", error);
        alert("Error al validar la sesi√≥n.");
        localStorage.clear();
        window.location.href = "index.html";
      });
    }

    function mostrarAccesoExpirado() {
      const videoArea = document.getElementById('videoArea');
      videoArea.innerHTML = '';

      let botonInicio = document.getElementById('botonInicio');
      if (!botonInicio) {
        const contenedorBoton = document.createElement('div');
        contenedorBoton.id = 'contenedorBoton';
        contenedorBoton.style.display = 'flex';
        botonInicio = document.createElement('button');
        botonInicio.id = 'botonInicio';
        botonInicio.textContent = 'Volver al inicio';
        botonInicio.addEventListener('click', () => {
          localStorage.clear();
          window.location.href = 'index.html';
        });
        contenedorBoton.appendChild(botonInicio);
        videoArea.appendChild(contenedorBoton);
      }

      document.getElementById('logoutBtn').style.display = 'none';
      timeLeftSpan.textContent = '00:00';
    }

    validarSesionCliente();

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    const slides = document.querySelectorAll('.promo-slide');
    let currentIndex = 0;

    function showNextSlide() {
      slides[currentIndex].classList.remove('active');
      currentIndex = (currentIndex + 1) % slides.length;
      slides[currentIndex].classList.add('active');
    }

    setInterval(showNextSlide, 5000);

    slides.forEach(img => {
      img.addEventListener('load', () => {
        const isHorizontal = img.naturalWidth >= img.naturalHeight;
        img.classList.add(isHorizontal ? 'horizontal' : 'vertical');
      });
      if (img.complete) {
        const isHorizontal = img.naturalWidth >= img.naturalHeight;
        img.classList.add(isHorizontal ? 'horizontal' : 'vertical');
      }
    });

  </script>
</body>
</html>
