<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Video en Vivo</title>
  <link rel="stylesheet" href="video-styles.css" />
  <link rel="icon" type="image/png" href="icons8-toro-48.png">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    .video-area iframe,
    .video-area video {
      width: 100%;
      height: 360px;
    }
  </style>
</head>
<body>
  <header>
    <h1 class="header-title">Transmisión en Vivo</h1>
  </header>

  <main class="main-content">
    <div class="stream-container">
      <section class="video-area-container">
        <div class="video-area" id="videoArea"></div>
        <button id="logoutBtn">Cerrar Sesión</button>
      </section>

      <aside class="ad-area" id="ad-area">
        <div id="timer">Tiempo restante: <span id="timeLeft">60:00</span></div>
        <h2>Promociones</h2>
        <div class="carousel">
          <img class="promo-slide active" src="gal8.jpg" alt="Promo 1" />
          <img class="promo-slide" src="gal6.jpg" alt="Promo 2" />
          <img class="promo-slide" src="gal7.jpg" alt="Promo 3" />
          <img class="promo-slide" src="gal9.jpg" alt="Promo 4" />
        </div>
      </aside>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Systems Department | Potenciando la calidad profesional</p>
  </footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAFyGzysyKuakKbvxQ4-V_dImZzRIn6sCk",
      authDomain: "proyectocamarasga.firebaseapp.com",
      databaseURL: "https://proyectocamarasga-default-rtdb.firebaseio.com",
      projectId: "proyectocamarasga",
      storageBucket: "proyectocamarasga.appspot.com",
      messagingSenderId: "234822313241",
      appId: "1:234822313241:web:3989ed7953383848d69188",
      measurementId: "G-MEGZ1G4ETH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const videoArea = document.getElementById('videoArea');
    const timeLeftSpan = document.getElementById('timeLeft');
    const tokenKey = "token_cliente";
    const cameraHLS = 'http://192.168.1.3:8080/stream.m3u8'; // IP local

    function cargarVideoHLS() {
      return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        video.controls = true;
        video.autoplay = true;
        video.muted = true;
        video.style.width = '100%';
        video.style.height = '360px';

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(cameraHLS);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            resolve(video);
          });

          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error("❌ Error HLS.js:", data);
            reject("Error al cargar el video.");
          });

          setTimeout(() => reject("Timeout cargando video"), 10000);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = cameraHLS;
          resolve(video);
        } else {
          reject("Tu navegador no soporta HLS");
        }
      });
    }

    async function cargarVideo() {
      try {
        const videoHLS = await cargarVideoHLS();
        videoArea.appendChild(videoHLS);
      } catch (error) {
        console.error("⚠️ No se pudo cargar el video:", error);
        videoArea.innerHTML = <p style="color:red;">No se pudo cargar la cámara en vivo.</p>;
      }
    }

    function actualizarTemporizador() {
      const expiracion = parseInt(localStorage.getItem('cliente_expiracion')) || 0;
      const ahora = Date.now();
      const diferencia = expiracion - ahora;

      if (diferencia <= 0) {
        alert("Tu acceso ha expirado. Gracias por visitarnos.");
        localStorage.clear();
        window.location.href = "index.html";
        return;
      }

      const minutos = Math.floor(diferencia / 60000);
      const segundos = Math.floor((diferencia % 60000) / 1000);
      timeLeftSpan.textContent = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
    }
  

    function validarSesionCliente() {
      const token = localStorage.getItem(tokenKey);
      const ahora = Date.now();
      let clienteExpiracion = parseInt(localStorage.getItem('cliente_expiracion'));

      if (!clienteExpiracion) {
        clienteExpiracion = ahora + 60 * 60 * 1000;
        localStorage.setItem('cliente_expiracion', clienteExpiracion);
      }

      if (!token) {
        alert("Sesión no válida. Inicia sesión nuevamente.");
        localStorage.clear();
        window.location.href = "index.html";
        return;
      }

      db.ref("tokens/" + token).once("value").then(snapshot => {
        const datos = snapshot.val();

        if (!datos || ahora < datos.inicio || ahora > datos.expiracion) {
          alert("Token inválido o fuera de vigencia.");
          localStorage.clear();
          window.location.href = "index.html";
          return;
        }

        cargarVideo();
        actualizarTemporizador();

        const intervalo = setInterval(() => {
          const expiracionLocal = parseInt(localStorage.getItem('cliente_expiracion')) || 0;
          const ahoraLocal = Date.now();
          const diff = expiracionLocal - ahoraLocal;

          if (diff <= 0) {
            clearInterval(intervalo);
            mostrarAccesoExpirado();
          } else {
            actualizarTemporizador();
          }
        }, 1000);

      }).catch(error => {
        console.error("Error al validar token:", error);
        alert("Error en la sesión.");
        localStorage.clear();
        window.location.href = "index.html";
      });
    }

    function mostrarAccesoExpirado() {
      videoArea.innerHTML = '';
      document.getElementById('logoutBtn').style.display = 'none';
      timeLeftSpan.textContent = '00:00';

      const contenedor = document.createElement('div');
      const botonInicio = document.createElement('button');
      botonInicio.textContent = 'Volver al inicio';
      botonInicio.addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'index.html';
      });

      contenedor.appendChild(botonInicio);
      videoArea.appendChild(contenedor);
    }

    validarSesionCliente();

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    const slides = document.querySelectorAll('.promo-slide');
    let currentIndex = 0;

    function showNextSlide() {
      slides[currentIndex].classList.remove('active');
      currentIndex = (currentIndex + 1) % slides.length;
      slides[currentIndex].classList.add('active');
    }

    setInterval(showNextSlide, 5000);

    slides.forEach(img => {
      img.addEventListener('load', () => {
        const isHorizontal = img.naturalWidth >= img.naturalHeight;
        img.classList.add(isHorizontal ? 'horizontal' : 'vertical');
      });

      if (img.complete) {
        const isHorizontal = img.naturalWidth >= img.naturalHeight;
        img.classList.add(isHorizontal ? 'horizontal' : 'vertical');
      }
    });
  </script>
</body>
</html> 
