<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login Cliente</title>
  <link rel="icon" type="image/png" href="icons8-toro-48.png">
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Acceso Cliente</h1>
  <form id="loginForm">
    <input type="text" id="nombre" placeholder="Nombre" required />
    <input type="number" id="mesa" placeholder="Número de mesa" required />
    <input type="text" id="token" placeholder="Token" required />
    <button type="submit">Entrar</button>
  </form>
  <p id="mensaje"></p>

  <footer>
    <p>&copy; 2025 Systems Department | Potenciando la calidad profesional</p>
  </footer>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyAFyGzysyKuakKbvxQ4-V_dImZzRIn6sCk",
    authDomain: "proyectocamarasga.firebaseapp.com",
    databaseURL: "https://proyectocamarasga-default-rtdb.firebaseio.com",
    projectId: "proyectocamarasga",
    storageBucket: "proyectocamarasga.appspot.com",
    messagingSenderId: "234822313241",
    appId: "1:234822313241:web:3989ed7953383848d69188",
    measurementId: "G-MEGZ1G4ETH"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const loginForm = document.getElementById('loginForm');
  const mensaje = document.getElementById('mensaje');

  // 📍 Coordenadas reales del restaurante
  const ubicacionPermitida = {
    lat: 31.733739,
    lng: -106.437678
  };

  function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const rad = Math.PI / 180;
    const dLat = (lat2 - lat1) * rad;
    const dLon = (lon2 - lon1) * rad;
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * rad) * Math.cos(lat2 * rad) *
              Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    mensaje.textContent = "";

    const nombre = document.getElementById('nombre').value.trim();
    const mesa = document.getElementById('mesa').value.trim();
    const token = document.getElementById('token').value.trim();

    if (!nombre || !mesa || !token) {
      mensaje.textContent = "Completa todos los campos";
      return;
    }

    if (!navigator.geolocation) {
      mensaje.textContent = "Tu navegador no soporta geolocalización.";
      return;
    }

    navigator.geolocation.getCurrentPosition(async (position) => {
      const latUsuario = position.coords.latitude;
      const lonUsuario = position.coords.longitude;

      const distancia = calcularDistancia(
        latUsuario, lonUsuario,
        ubicacionPermitida.lat, ubicacionPermitida.lng
      );

      const radioPermitido = 200; // 🎯 actualizado a 200 metros

      if (distancia > radioPermitido) {
        mensaje.textContent = `Estás fuera de la zona permitida (${Math.round(distancia)}m).`;
        return;
      }

      // Mostrar ubicación y distancia detectada en pantalla (opcional)
      const debug = document.createElement('div');
      debug.style.color = 'gray';
      debug.style.fontSize = '12px';
      debug.style.marginTop = '10px';
      debug.innerText = `📍 Tu ubicación detectada: ${latUsuario.toFixed(6)}, ${lonUsuario.toFixed(6)}\n📏 Distancia al restaurante: ${Math.round(distancia)} metros`;
      mensaje.appendChild(debug);

      try {
        const snapshot = await db.ref('tokens/' + token).once('value');
        if (!snapshot.exists()) {
          mensaje.textContent = "Token inválido";
          return;
        }

        const tokenData = snapshot.val();
        const now = Date.now();

        if (now > tokenData.expiracion) {
          mensaje.textContent = "Token expirado";
          return;
        }

        const clienteInfo = {
          nombre: nombre,
          mesa: mesa,
          token: token,
          timestamp: now
        };

        await db.ref("clientes/" + token).push(clienteInfo);

        const clienteExpiracion = now + 60 * 60 * 1000;

        localStorage.setItem('acceso_token', token);
        localStorage.setItem('acceso_expiracion', tokenData.expiracion);
        localStorage.setItem('token_cliente', token);
        localStorage.setItem('cliente_expiracion', clienteExpiracion);
        localStorage.setItem('cliente_nombre', nombre);
        localStorage.setItem('cliente_mesa', mesa);

        window.location.href = 'video.html';

      } catch (error) {
        mensaje.textContent = "Error al validar token";
        console.error(error);
      }

    }, () => {
      mensaje.textContent = "No pudimos obtener tu ubicación. Activa GPS o da permisos.";
    });
  });
</script>

</body>
</html>
